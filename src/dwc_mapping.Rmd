---
title: "Mapping to Darwin Core"
author: "Quentin Groom & Peter Desmet"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Setup

Set locale (so we use UTF-8 character encoding):

```{r set_locale}
# This works on Mac OS X, might not work on other OS
Sys.setlocale("LC_ALL", 'en_US.UTF-8')
```

Load libraries:

```{r load_libraries}
library(janitor)
library(tidyr)
library(dplyr)
library(readxl)
```

Set file paths:

```{r set_file_paths}
# All paths should be relative to this script
input_checklist_file = "../data/raw/Checklist2.xls"
output_taxon_file = "../data/processed/taxon.csv"
output_distribution_file = "../data/processed/distribution.csv"
output_description_file = "../data/processed/description.csv"
```

## Read data

Read the source checklist (an Excel file):

```{r read_excel}
read_excel(
  path = input_checklist_file,
  skip = 1 # First row is empty
) -> checklist
```

Remove empty rows and process the `Fl.`, `Br.`, `Wa.` "presence" headers on the first row:

```{r handle_empty_rows}
checklist %>%
# Remove empty rows
remove_empty_rows() %>%

# The headers for "Presence" are on the first row (Fl., Br., Wa.), so we need to 
# rename the first row headers to keep this information
rename(Presence_Fl = Presence, Presence_Br = X__1, Presence_Wa = X__2) %>%
  
# We can now remove that first row, by slicing from 2 till the end
slice(2:(n())) -> checklist
```

Add row number as an identifier (`ID`) and save the column names for future reference:

```{r add_id_store_colnames}
# Add ID as first column
checklist <- cbind("ID" = seq.int(nrow(checklist)), checklist)

# Save column names
checklist_colnames <- colnames(checklist)
```

Preview data:

```{r head_checklist}
head(checklist)
```

## Create taxon core

Map the source data to [Darwin Core Taxon](http://rs.gbif.org/core/dwc_taxon_2015-04-24.xml):

```{r taxon_mapping}
checklist %>%
mutate(
  id = ID,
  # modified
  language = "en",
  license = "http://creativecommons.org/publicdomain/zero/1.0/",
  rightsHolder = "Botanic Garden Meise",
  # accessRights
  # bibliographicCitation
  # informationWithheld
  datasetID = "", # Should become the DOI
  datasetName = "Manual of the Alien Plants of Belgium", 
  # references
  taxonID = ID,
  # scientificNameID
  # acceptedNameUsageID
  # parentNameUsageID
  # originalNameUsageID
  # nameAccordingToID
  # namePublishedInID
  # taxonConceptID
  scientificName = Taxon,
  # acceptedNameUsage
  # parentNameUsage
  # originalNameUsage
  # nameAccordingTo
  # namePublishedIn
  # namePublishedInYear
  # higherClassification
  kingdom = "Plantae",
  # phylum
  # class
  # order
  family = Family,
  # genus
  # subgenus
  # specificEpithet
  # infraspecificEpithet
  # taxonRank
  # verbatimTaxonRank
  # scientificNameAuthorship
  # vernacularName
  nomenclaturalCode = "ICBN"
  # taxonomicStatus
  # nomenclaturalStatus
  # taxonRemarks
) %>%
  
# Remove the original columns
select(-one_of(checklist_colnames)) -> taxon

# Preview data
head(taxon)
```

Save to CSV:

```{r save_taxon_csv}
write.csv(taxon, file = output_taxon_file, na = "", row.names = FALSE)
```

## Create distribution extension

Create a `Presence_Be` column, which contains `X` if any of the regions has `X` and if not has `?` if any of the regions has `?`:

```{r add_presence_be}
checklist %>%
mutate(Presence_Be = case_when(
  .$Presence_Fl == "X" | .$Presence_Br == "X" | .$Presence_Wa == "X" ~ "X",
  .$Presence_Fl == "?" | .$Presence_Br == "?" | .$Presence_Wa == "?" ~ "?")
) -> distribution
```

Create records for each value in the four presence columns but not for `NA` values:

```{r create_distribution_records}
distribution %>%
gather(
  presence_area, presence_value,
  Presence_Be, Presence_Br, Presence_Fl, Presence_Wa,
  na.rm = TRUE,
  convert = FALSE
) %>%

# Sort on ID
arrange(ID) -> distribution
```

Map the source data to [Species Distribution](http://rs.gbif.org/extension/gbif/1.0/distribution.xml):

```{r distribution_mapping}
distribution %>%
mutate(
  id = ID,
  locationID = paste0("ISO3166-2:", case_when(
    .$presence_area == "Presence_Be" ~ "BE",
    .$presence_area == "Presence_Br" ~ "BE-BRU",
    .$presence_area == "Presence_Fl" ~ "BE-VLG",
    .$presence_area == "Presence_Wa" ~ "BE-WAL"
  )),
  locality = case_when(
    .$presence_area == "Presence_Be" ~ "Belgium",
    .$presence_area == "Presence_Br" ~ "Brussels-Capital Region",
    .$presence_area == "Presence_Fl" ~ "Flemish Region",
    .$presence_area == "Presence_Wa" ~ "Walloon Region"
  ),
  countryCode = "BE",
  # lifeStage
  occurrenceStatus = case_when(
    .$presence_value == "X" ~ "present",
    .$presence_value == "?" ~ "unknown"
  )
  # threatStatus
  # establishmentMeans
  # appendixCITES
  # eventDate
  # startDayOfYear
  # endDayOfYear
  # source
  # occurrenceRemarks
  # datasetID
) %>%
  
# Remove the original columns + the two presence ones
select(-one_of(checklist_colnames), -presence_area, -presence_value) -> distribution

# Preview data
head(distribution)
```

Save to CSV:

```{r save_taxon_csv}
write.csv(distribution, file = output_distribution_file, na = "", row.names = FALSE)
```
